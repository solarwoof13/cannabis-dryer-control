<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=1024, height=600, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            width: 1024px;
            height: 600px;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            position: relative;
            user-select: none;
        }

        /* TOP BAR - Reduced to 30px */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, rgba(30, 30, 30, 0.95), rgba(20, 20, 20, 0.9));
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wifi-layout {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wifi-signal svg {
            width: 18px;
            height: 18px;
        }

        .wifi-status {
            color: #00C310;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clock-layout {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .current-time {
            color: white;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .current-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00C310;
            box-shadow: 0 0 6px #00C310;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* NAVIGATION BAR - Reduced to 35px */
        .nav-bar {
            position: absolute;
            top: 35px;
            left: 8px;
            right: 8px;
            height: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 900;
        }

        .nav-buttons {
            display: flex;
            gap: 6px;
        }

        .nav-button {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.1), rgba(102, 51, 187, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(136, 88, 237, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .nav-button:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.2), rgba(102, 51, 187, 0.2));
            box-shadow: 0 4px 10px rgba(136, 88, 237, 0.3);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #8858ed, #6633bb);
            border-color: #8858ed;
        }

        .nav-button svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        .nav-button span {
            color: white;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .emergency-button {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(204, 0, 0, 0.1));
            border: 1px solid rgba(255, 0, 0, 0.4);
        }

        .emergency-button:hover {
            background: linear-gradient(135deg, #FF4444, #CC0000);
            box-shadow: 0 4px 10px rgba(255, 0, 0, 0.4);
        }

        .emergency-button.active {
            background: linear-gradient(135deg, #FF0000, #CC0000) !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8) !important;
            transform: scale(1.05);
        }

        .start-button {
            background: linear-gradient(135deg, rgba(0, 195, 16, 0.2), rgba(0, 227, 21, 0.1));
            border: 1px solid rgba(0, 195, 16, 0.4);
        }

        .start-button:hover {
            background: linear-gradient(135deg, #00C310, #00E515);
            box-shadow: 0 4px 10px rgba(0, 195, 16, 0.4);
        }

        .start-button.active {
            background: linear-gradient(135deg, #00E515, #00C310) !important;
            box-shadow: 0 0 20px rgba(0, 229, 21, 0.8) !important;
            transform: scale(1.05);
        }

        .hold-button {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.2), rgba(102, 51, 187, 0.1));
            border: 1px solid rgba(136, 88, 237, 0.3);
        }

        .hold-button:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            box-shadow: 0 4px 10px rgba(255, 165, 0, 0.4);
        }

        .hold-button.active {
            background: linear-gradient(135deg, #FFB700, #FFA500) !important;
            box-shadow: 0 0 20px rgba(255, 183, 0, 0.8) !important;
            transform: scale(1.05);
        }

        /* MAIN CONTAINER - Adjusted for screen size */
        .main-container {
            position: absolute;
            top: 75px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            display: grid;
            grid-template-columns: 0.9fr 1.1fr 0.9fr;
            gap: 10px;
            height: 517px; /* 600 - 75 (top) - 8 (bottom) */
        }

        /* LEFT PANEL - SENSORS */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sensor-card {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.1), rgba(102, 51, 187, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(136, 88, 237, 0.2);
            padding: 12px;
            transition: all 0.3s ease;
        }

        .sensor-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(136, 88, 237, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sensor-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00C310;
            box-shadow: 0 0 6px #00C310;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .sensor-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sensor-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
        }

        .sensor-values-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-value {
            color: white;
            font-size: 18px;
            font-weight: 800;
        }

        .sensor-humidity {
            color: #4A90E2;
            font-size: 18px;
            font-weight: 800;
        }

        .sensor-unit {
            color: #8858ed;
            font-size: 10px;
            font-weight: 600;
            margin-left: 2px;
        }

        .sensor-unit-humid {
            color: #4A90E2;
            font-size: 10px;
            font-weight: 600;
            margin-left: 2px;
        }

        /* CENTER PANEL - VPD */
        .center-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .vpd-main-card {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.15), rgba(102, 51, 187, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(136, 88, 237, 0.3);
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 330px;
        }

        .mode-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 6px 15px;
            border: 1px solid rgba(136, 88, 237, 0.3);
        }

        .mode-text {
            color: white;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-progress {
            color: #8858ed;
            font-size: 9px;
            font-weight: 600;
            text-align: center;
            margin-top: 2px;
        }

        .vpd-display {
            text-align: center;
            margin: 25px 0;
        }

        .vpd-large-value {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(135deg, #8858ed, #6633bb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            text-shadow: 0 4px 20px rgba(136, 88, 237, 0.3);
        }

        .vpd-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 8px;
        }

        .vpd-range {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .range-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .range-value {
            color: #00C310;
            font-size: 15px;
            font-weight: 700;
        }

        /* VPD GAUGE - Replace the existing .vpd-gauge-simple styles */
        .vpd-gauge-simple {
            position: relative;
            width: 100%;
            max-width: 260px;
            height: 18px;
            margin-top: 20px;
            border-radius: 9px;
            overflow: visible;
            background: linear-gradient(
                to right,
                #FF0000 0%,      /* 0.3 kPa - Far left red */
                #FF4444 15%,     /* 0.5 kPa - Red zone */
                #FF9900 25%,     /* 0.6 kPa - Orange warning */
                #FFD700 35%,     /* 0.65 kPa - Yellow caution */
                #00FF00 40%,     /* 0.7 kPa - Green START */
                #00FF00 47%,     /* 0.75 kPa - Green CENTER */
                #00FF00 53%,     /* 0.8 kPa - Green END */
                #FFD700 58%,     /* 0.85 kPa - Yellow caution */
                #FF9900 70%,     /* 1.0 kPa - Orange warning */
                #FF4444 85%,     /* 1.5 kPa - Red zone */
                #FF0000 100%     /* 2.0 kPa - Far right red */
            );
            box-shadow: 
                inset 0 2px 8px rgba(0,0,0,0.4), 
                0 1px 2px rgba(0,0,0,0.3);
        }

        /* Hide the gauge-fill completely */
        .gauge-fill {
            display: none !important;
        }

        /* Triangle indicator that moves along the gauge */
        .gauge-indicator {
            position: absolute;
            top: -8px; /* Position triangle above the bar */
            width: 0;
            height: 0;
            /* Triangle pointing down */
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid white;
            transition: left 0.5s ease;
            z-index: 10;
            /* Add subtle shadow for visibility */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            transform: translateX(-50%);
        }

        .gauge-indicator::before {
            display: none !important;
        }

        .adjust-button {
            margin-top: 20px;
            padding: 10px 25px;
            background: linear-gradient(135deg, #8858ed, #6633bb);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(136, 88, 237, 0.3);
        }

        .adjust-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(136, 88, 237, 0.4);
        }

        /* PROCESS STATUS */
        .process-status-card {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.1), rgba(102, 51, 187, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(136, 88, 237, 0.2);
            padding: 15px;
            width: 100%;
            height: 167px;
        }

        .status-phase {
            margin-bottom: 15px;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .phase-name {
            color: white;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .phase-time {
            color: #8858ed;
            font-size: 10px;
            font-weight: 600;
        }

        .phase-bar {
            height: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .phase-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: width 0.5s ease;
        }

        .phase-fill.complete {
            background: linear-gradient(90deg, #00C310, #00E515);
            width: 100%;
        }

        .phase-fill.active {
            background: linear-gradient(90deg, #8858ed, #6633bb);
        }

        .phase-text {
            color: white;
            font-size: 8px;
            font-weight: 700;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* RIGHT PANEL */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* EQUIPMENT STATUS */
        .equipment-card {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.1), rgba(102, 51, 187, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(136, 88, 237, 0.2);
            padding: 12px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .equipment-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .equipment-item:hover {
            transform: translateY(-1px);
            border-color: rgba(136, 88, 237, 0.3);
        }

        .equipment-name {
            color: rgba(255, 255, 255, 0.7);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 5px;
        }

        .equipment-status-text {
            color: white;
            font-size: 11px;
            font-weight: 700;
        }

        .equipment-item.on {
            background: linear-gradient(135deg, rgba(0, 195, 16, 0.2), rgba(0, 227, 21, 0.1));
            border-color: rgba(0, 195, 16, 0.4);
        }

        .equipment-item.idle {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.1));
            border-color: rgba(255, 165, 0, 0.4);
        }

        .equipment-item.off {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(204, 0, 0, 0.1));
            border-color: rgba(255, 68, 68, 0.4);
        }

        .equipment-item {
            position: relative;
            cursor: pointer;
        }

        .equipment-mode {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: bold;
        }

        .equipment-item.auto .equipment-mode {
            background: #4CAF50;
        }

        .equipment-item.manual-on .equipment-mode {
            background: #2196F3;
        }

        .equipment-item.manual-off .equipment-mode {
            background: #f44336;
        }

        .equipment-auto-state {
            font-size: 9px;
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
        }

        /* ALERTS */
        .alerts-card {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(204, 0, 0, 0.05));
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        .alert-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #FF4444;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-icon {
            width: 14px;
            height: 14px;
            color: #FF4444;
        }

        .alert-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 10px;
            font-weight: 500;
            flex: 1;
        }

        .alert-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
        }

        /* ROOM SUMMARY */
        .room-summary {
            background: linear-gradient(135deg, rgba(136, 88, 237, 0.1), rgba(102, 51, 187, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(136, 88, 237, 0.2);
            padding: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            color: white;
            font-size: 20px;
            font-weight: 800;
        }

        .summary-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="wifi-layout">
            <div class="wifi-signal">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1.42 9a16 16 0 0 1 21.16 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="20" x2="12.01" y2="20" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="wifi-status">CONNECTED</div>
        </div>
        <div class="clock-layout">
            <div class="current-time" id="currentTime">-- PM</div>
            <div class="current-date" id="currentDate">--</div>
        </div>
        <div class="system-status">
            <div class="status-dot"></div>
            <div class="status-text">System Active</div>
        </div>
    </div>

    <!-- NAVIGATION BAR -->
    <div class="nav-bar">
        <div class="nav-buttons">
            <button class="nav-button active" onclick="goHome()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                <span>Home</span>
            </button>
            <button class="nav-button" onclick="openSettings()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m5.7-5.7L11 11l-4.3 4.3m0-8.6L11 11l4.3-4.3"/>
                </svg>
                <span>Settings</span>
            </button>
            <button class="nav-button" onclick="openAnalytics()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Analytics</span>
            </button>
        </div>
        <div class="nav-buttons" style="display: flex; gap: 6px; align-items: center;">
            <button class="nav-button start-button" id="start-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5,3 19,12 5,21 5,3"/>
                </svg>
                <span>Start</span>
            </button>
            <button class="nav-button hold-button" id="hold-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="4" width="12" height="16" rx="2"/>
                </svg>
                <span>Hold</span>
            </button>
            <button class="nav-button emergency-button" onclick="emergencyStop()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                </svg>
                <span>EMERGENCY STOP</span>
            </button>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- LEFT PANEL - SENSORS -->
        <div class="left-panel">
            <div class="sensor-card">
                <div class="card-header">
                    <div class="card-title">Zone Sensors</div>
                    <div class="sensor-status"></div>
                </div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-label">Zone 1</div>
                        <div class="sensor-values-row">
                            <div class="sensor-value" data-sensor="zone1-temp"><span class="sensor-unit">°F</span></div>
                            <div class="sensor-humidity" data-sensor="zone1-humid"><span class="sensor-unit-humid">%</span></div>
                        </div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Zone 2</div>
                        <div class="sensor-values-row">
                            <div class="sensor-value" data-sensor="zone2-temp"><span class="sensor-unit">°F</span></div>
                            <div class="sensor-humidity" data-sensor="zone2-humid"><span class="sensor-unit-humid">%</span></div>
                        </div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Zone 3</div>
                        <div class="sensor-values-row">
                            <div class="sensor-value" data-sensor="zone3-temp"><span class="sensor-unit">°F</span></div>
                            <div class="sensor-humidity" data-sensor="zone3-humid"><span class="sensor-unit-humid">%</span></div>
                        </div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Zone 4</div>
                        <div class="sensor-values-row">
                            <div class="sensor-value" data-sensor="zone4-temp"><span class="sensor-unit">°F</span></div>
                            <div class="sensor-humidity" data-sensor="zone4-humid"><span class="sensor-unit-humid">%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="card-header">
                    <div class="card-title">Air Control</div>
                    <div class="sensor-status"></div>
                </div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-label">Supply</div>
                        <div class="sensor-value" data-sensor="supply"><span class="sensor-unit">°F</span></div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Return</div>
                        <div class="sensor-value" data-sensor="return"><span class="sensor-unit">°F</span></div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Supply RH</div>
                        <div class="sensor-value" data-sensor="supply-rh"><span class="sensor-unit">%</span></div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Return RH</div>
                        <div class="sensor-value" data-sensor="return-rh"><span class="sensor-unit">%</span></div>
                    </div>
                </div>
            </div>

            <div class="room-summary">
                <div class="card-header">
                    <div class="card-title">Room Averages</div>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="avg-temp">--°F</div>
                        <div class="summary-label">Temperature</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="avg-humid">--%</div>
                        <div class="summary-label">Humidity</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="avg-dewpoint">--°F</div>
                        <div class="summary-label">Dew Point</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="water-activity">--</div>
                        <div class="summary-label">Water Activity</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL - VPD -->
        <div class="center-panel">
            <div class="vpd-main-card">
                <div class="mode-indicator">
                    <div class="mode-text" id="modeText">CURE MODE</div>
                    <div class="mode-progress" id="modeProgress">Day 2 of 4</div>
                </div>

                <div class="vpd-display">
                    <div class="vpd-large-value" id="vpdValue">--</div>
                    <div class="vpd-label">VPD (kPa)</div>
                </div>

                <div class="vpd-range">
                    <div>
                        <div class="range-label">Target</div>
                        <div class="range-value">1.2-1.3</div>
                    </div>
                    <div>
                        <div class="range-label">Current Status</div>
                        <div class="range-value" style="color: #00C310;">OPTIMAL</div>
                    </div>
                </div>

                <div class="vpd-gauge-simple">
                    <div class="gauge-fill"></div>
                    <div class="gauge-indicator" id="vpdIndicator" style="left: 60%;"></div>
                </div>

                <button class="adjust-button" onclick="adjustSetpoint()">Adjust Setpoint</button>
            </div>

            <div class="process-status-card">
                <div class="status-phase">
                    <div class="phase-header">
                        <div class="phase-name">Drying Phase</div>
                        <div class="phase-time">Complete</div>
                    </div>
                    <div class="phase-bar">
                        <div class="phase-fill complete">
                            <div class="phase-text">100% COMPLETE</div>
                        </div>
                    </div>
                </div>
                <div class="status-phase">
                    <div class="phase-header">
                        <div class="phase-name">Curing Phase</div>
                        <div class="phase-time">-d -h remaining</div>
                    </div>
                    <div class="phase-bar">
                        <div class="phase-fill active" style="width: 45%;">
                            <div class="phase-text">45%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
            <div class="equipment-card">
                <div class="card-header">
                    <div class="card-title">Equipment Status</div>
                </div>
                <div class="equipment-grid">
                    <div class="equipment-item on" data-equipment="mini_split" onclick="toggleEquipment(this, 'mini-split')">
                        <div class="equipment-name">Mini-Split</div>
                        <div class="equipment-status-text">ON</div>
                    </div>
                    <div class="equipment-item idle" data-equipment="dehum" onclick="toggleEquipment(this, 'dehumidifier')">
                        <div class="equipment-name">Dehumidifier</div>
                        <div class="equipment-status-text">IDLE</div>
                    </div>
                    <div class="equipment-item off" data-equipment="hum" onclick="toggleEquipment(this, 'humidifier')">
                        <div class="equipment-name">Humidifier</div>
                        <div class="equipment-status-text">OFF</div>
                    </div>
                    <div class="equipment-item on" data-equipment="erv" onclick="toggleEquipment(this, 'erv')">
                        <div class="equipment-name">ERV</div>
                        <div class="equipment-status-text">ON</div>
                    </div>
                    <div class="equipment-item on" data-equipment="supply_fan" onclick="toggleEquipment(this, 'supply-fan')">
                        <div class="equipment-name">Supply Fan</div>
                        <div class="equipment-status-text">60%</div>
                    </div>
                    <div class="equipment-item on" data-equipment="return_fan" onclick="toggleEquipment(this, 'exhaust-fan')">
                        <div class="equipment-name">Exhaust Fan</div>
                        <div class="equipment-status-text">60%</div>
                    </div>
                </div>
            </div>

            <div class="sensor-card alerts-card">
                <div class="card-header">
                    <div class="card-title">Active Alerts</div>
                </div>
                <div class="alert-item">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                    <div class="alert-text">Zone 3 humidity approaching limit</div>
                    <div class="alert-time">2m</div>
                </div>
                <div class="alert-item" style="border-left-color: #FFA500;">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="#FFA500">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12" stroke="white" stroke-width="2"/>
                        <line x1="12" y1="16" x2="12.01" y2="16" stroke="white" stroke-width="2"/>
                    </svg>
                    <div class="alert-text">Maintenance due in 48 hours</div>
                    <div class="alert-time">1h</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="card-header">
                    <div class="card-title">Quick Stats</div>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">18.5h</div>
                        <div class="summary-label">Runtime Today</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">92%</div>
                        <div class="summary-label">Efficiency</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">3</div>
                        <div class="summary-label">Alerts (24h)</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">Good</div>
                        <div class="summary-label">Air Quality</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>

        // Constants
        const VPD_MIN = 0.3;   // Absolute minimum for safety
        const VPD_MAX = 2.0;   // Absolute maximum for safety
        let systemState = 'idle';  // idle, running, holding, complete, emergency
        let VPD_TARGET_MIN = 0.7;    // Will be replaced with actual value
        let VPD_TARGET_MAX = 0.8;    // Will be replaced with actual value
        let currentVPD = 0.75;        // Will be replaced with actual value
        let cycleState = 'idle';
        let dryingProgress = 0;    // 0-100%
        let curingProgress = 0;     // 0-100%
        let currentPhase = 'idle'; // idle, drying, curing, storage
        let phaseDay = 0;
        let totalPhaseDays = 0;
        let processStartTime = null;

        function updateButtonStates() {
            const startBtn = document.getElementById('start-btn');
            const holdBtn = document.getElementById('hold-btn');
            const stopBtn = document.querySelector('.emergency-button');
            
            // Remove ALL active states first
            if (startBtn) startBtn.classList.remove('active');
            if (holdBtn) holdBtn.classList.remove('active');
            if (stopBtn) stopBtn.classList.remove('active');
            
            // Set button enabled/disabled and highlight based on current state
            if (cycleState === 'running') {
                // START is active and highlighted
                if (startBtn) {
                    startBtn.classList.add('active');
                    startBtn.disabled = false;
                }
                if (holdBtn) holdBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = false;
                
            } else if (cycleState === 'holding') {
                // HOLD is active and highlighted
                if (holdBtn) {
                    holdBtn.classList.add('active');
                    holdBtn.disabled = false;
                }
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = false;
                
            } else if (cycleState === 'emergency') {
                // EMERGENCY STOP is active and highlighted
                if (stopBtn) {
                    stopBtn.classList.add('active');
                    stopBtn.disabled = false;
                }
                // Allow resuming from emergency with start or hold buttons
                if (startBtn) startBtn.disabled = false;
                if (holdBtn) holdBtn.disabled = false;
                
            } else {
                // IDLE state - all buttons normal (not highlighted)
                if (startBtn) startBtn.disabled = false;
                if (holdBtn) holdBtn.disabled = true; // Can only hold when running
                if (stopBtn) stopBtn.disabled = false;
            }
        }

        // Function to get real data from your Python controller
        function updateFromController() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // DON'T overwrite emergency state from backend until user takes action
                    if (cycleState !== 'emergency') {
                        // Only update state if not in emergency mode
                        if (data.cycle_state) {
                            cycleState = data.cycle_state;
                        } else if (data.system_state) {
                            cycleState = data.system_state;
                        }
                        systemState = data.system_state || 'idle';
                    }
                    
                    currentPhase = data.phase || 'idle';
                    dryingProgress = data.drying_progress || 0;
                    curingProgress = data.curing_progress || 0;
                    
                    // Update displays
                    updateButtonStates();
                    updateSystemModeDisplay();
                    updateProgressBars();
                    updateVPDDisplay();
                })
                .catch(error => {
                    console.log('Waiting for backend...', error);
                    if (cycleState !== 'emergency') {
                        cycleState = 'idle';
                        systemState = 'idle';
                    }
                    updateButtonStates();
                    updateSystemModeDisplay();
                });
        }

       // Update the VPD display function to use the new variables
        function updateVPDDisplay() {
            const vpdValue = document.getElementById('vpdValue');
            const vpdIndicator = document.getElementById('vpdIndicator');
            
            if (vpdValue) {
                vpdValue.textContent = currentVPD.toFixed(2);
            }
            
            // Update Target range display - NOW USES REAL VALUES
            const rangeValues = document.querySelectorAll('.vpd-range .range-value');
            if (rangeValues[0]) {
                rangeValues[0].textContent = `${VPD_TARGET_MIN.toFixed(2)}-${VPD_TARGET_MAX.toFixed(2)}`;
            }
            
            // Update Current Status
            if (rangeValues[1]) {
                const warningTolerance = 0.1;
                let statusText = '';
                let statusColor = '';
                
                if (currentVPD >= VPD_TARGET_MIN && currentVPD <= VPD_TARGET_MAX) {
                    statusText = 'OPTIMAL';
                    statusColor = '#00E515';
                } else if (currentVPD >= (VPD_TARGET_MIN - warningTolerance) && 
                        currentVPD <= (VPD_TARGET_MAX + warningTolerance)) {
                    statusText = 'WARNING';
                    statusColor = '#FFD700';
                } else {
                    statusText = 'CRITICAL';
                    statusColor = '#FF4444';
                }
                
                rangeValues[1].textContent = statusText;
                rangeValues[1].style.color = statusColor;
                rangeValues[1].style.fontWeight = '700';
                rangeValues[1].style.textShadow = `0 0 10px ${statusColor}40`;
            }
            
            if (vpdIndicator) {
                // Update indicator position (0.3 to 2.0 kPa range)
                const position = ((currentVPD - VPD_MIN) / (VPD_MAX - VPD_MIN)) * 100;
                vpdIndicator.style.left = `${Math.max(0, Math.min(100, position))}%`;
                vpdIndicator.style.transform = 'translateX(-50%)'; // Center the triangle
                
                // Update indicator color based on status
                const warningTolerance = 0.1;
                if (currentVPD >= VPD_TARGET_MIN && currentVPD <= VPD_TARGET_MAX) {
                    vpdIndicator.style.background = '#00E515';
                    vpdIndicator.style.boxShadow = '0 0 15px #00E515';
                } else if (currentVPD >= (VPD_TARGET_MIN - warningTolerance) && currentVPD <= (VPD_TARGET_MAX + warningTolerance)) {
                    vpdIndicator.style.background = '#FFD700';
                    vpdIndicator.style.boxShadow = '0 0 15px #FFD700';
                } else {
                    vpdIndicator.style.background = '#FF4444';
                    vpdIndicator.style.boxShadow = '0 0 15px #FF4444';
                }
            }
            
            // Update VPD value color based on status
            if (vpdValue) {
                if (currentVPD >= VPD_TARGET_MIN && currentVPD <= VPD_TARGET_MAX) {
                    vpdValue.style.background = 'linear-gradient(135deg, #00C310, #00E515)';
                } else if (currentVPD >= (VPD_TARGET_MIN - 0.1) && currentVPD <= (VPD_TARGET_MAX + 0.1)) {
                    vpdValue.style.background = 'linear-gradient(135deg, #FFA500, #FFD700)';
                } else {
                    vpdValue.style.background = 'linear-gradient(135deg, #FF4444, #FF6666)';
                }
                vpdValue.style.webkitBackgroundClip = 'text';
                vpdValue.style.webkitTextFillColor = 'transparent';
            }
        }

        function updateSystemModeDisplay() {
            const modeText = document.getElementById('modeText');
            const modeProgress = document.getElementById('modeProgress');
            
            if (modeText && modeProgress) {
                // Check for emergency state first
                if (cycleState === 'emergency') {
                    modeText.textContent = 'EMERGENCY STOP';
                    modeProgress.textContent = 'System Stopped';
                    modeText.style.color = '#FF4444';
                    return;
                }
                
                // Map backend phase names to display
                const phaseMap = {
                    'dry_initial': { text: 'DRYING MODE', subtext: 'Day 1-2', color: '#FFD700' },
                    'dry_mid': { text: 'DRYING MODE', subtext: 'Day 3-5', color: '#FFD700' },
                    'dry_final': { text: 'DRYING MODE', subtext: 'Day 6-7', color: '#FFD700' },
                    'cure': { text: 'CURING MODE', subtext: 'Day 8-10', color: '#8858ed' },
                    'storage': { text: 'STORAGE MODE', subtext: 'Process Complete', color: '#00E515' },
                    'idle': { text: 'IDLE MODE', subtext: 'System Ready', color: '#888' },
                    'complete': { text: 'COMPLETE', subtext: 'Ready for Harvest', color: '#00E515' }
                };
                
                const phase = currentPhase || 'idle';
                const display = phaseMap[phase] || phaseMap['idle'];
                
                modeText.textContent = display.text;
                modeProgress.textContent = display.subtext;
                modeText.style.color = display.color;
            }
        }

        function updateProgressBars() {
            // Update Drying Phase
            const dryingHeader = document.querySelector('.status-phase:first-child .phase-header');
            const dryingBar = document.querySelector('.status-phase:first-child .phase-fill');
            const dryingText = document.querySelector('.status-phase:first-child .phase-text');
            
            if (dryingBar && dryingText) {
                dryingBar.style.width = `${dryingProgress}%`;
                
                if (dryingProgress >= 100) {
                    dryingText.textContent = 'DONE';
                } else if (currentPhase && currentPhase.startsWith('dry_')) {
                    dryingText.textContent = `${dryingProgress}%`;
                } else if (dryingProgress > 0) {
                    dryingText.textContent = `${dryingProgress}%`;
                } else {
                    dryingText.textContent = '0%';
                }
                
                if (dryingProgress >= 100) {
                    dryingBar.classList.add('complete');
                    dryingBar.classList.remove('active');
                } else if (dryingProgress > 0) {
                    dryingBar.classList.add('active');
                    dryingBar.classList.remove('complete');
                } else {
                    dryingBar.classList.remove('active', 'complete');
                }
            }
            
            if (dryingHeader) {
                const timeDiv = dryingHeader.querySelector('.phase-time');
                if (timeDiv) {
                    if (dryingProgress >= 100) {
                        timeDiv.textContent = 'Complete';
                        timeDiv.style.color = '#00E515';
                    } else if (currentPhase && currentPhase.startsWith('dry_')) {
                        timeDiv.textContent = 'In Progress';
                        timeDiv.style.color = '#FFD700';
                    } else if (dryingProgress > 0) {
                        timeDiv.textContent = 'Pending';
                        timeDiv.style.color = '#FFA500';
                    } else {
                        timeDiv.textContent = 'Not Started';
                        timeDiv.style.color = '#888';
                    }
                }
            }
            
            // Update Curing Phase
            const curingHeader = document.querySelector('.status-phase:last-child .phase-header');
            const curingBar = document.querySelector('.status-phase:last-child .phase-fill');
            const curingText = document.querySelector('.status-phase:last-child .phase-text');
            
            if (curingBar && curingText) {
                curingBar.style.width = `${curingProgress}%`;
                
                if (curingProgress >= 100) {
                    curingText.textContent = 'DONE';
                } else if (currentPhase === 'cure') {
                    curingText.textContent = `${curingProgress}%`;
                } else if (curingProgress > 0) {
                    curingText.textContent = `${curingProgress}%`;
                } else {
                    curingText.textContent = '0%';
                }
                
                if (curingProgress >= 100) {
                    curingBar.classList.add('complete');
                    curingBar.classList.remove('active');
                } else if (curingProgress > 0) {
                    curingBar.classList.add('active');
                    curingBar.classList.remove('complete');
                } else {
                    curingBar.classList.remove('active', 'complete');
                }
            }
            
            if (curingHeader) {
                const timeDiv = curingHeader.querySelector('.phase-time');
                if (timeDiv) {
                    if (curingProgress >= 100) {
                        timeDiv.textContent = 'Complete';
                        timeDiv.style.color = '#00E515';
                    } else if (currentPhase === 'cure') {
                        timeDiv.textContent = 'In Progress';
                        timeDiv.style.color = '#8858ed';
                    } else if (dryingProgress >= 100) {
                        timeDiv.textContent = 'Ready to Start';
                        timeDiv.style.color = '#FFD700';
                    } else {
                        timeDiv.textContent = 'Pending';
                        timeDiv.style.color = '#888';
                    }
                }
            }
        }  // THIS CLOSING BRACE WAS MISSING!

        function startProcess() {
            if (systemState !== 'idle' && systemState !== 'complete') {
                alert('Process already running!');
                return;
            }
            
            if (confirm('Start new drying and curing process?\n\nThis will begin a new 8-day cycle.')) {
                fetch('/api/start-cycle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mode: 'standard',
                        drying_days: 4,
                        curing_days: 4,
                        target_water_activity: 0.62
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Process started:', data);
                    systemState = 'running';
                    currentPhase = 'drying';
                    processStartTime = new Date();
                    updateFromController();
                })
                .catch(err => {
                    console.error('Failed to start process:', err);
                    alert('Failed to start process. Check system connection.');
                });
            }
        }

        // Update time and date
        function updateClock() {
            const now = new Date();
            const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
            const dateOptions = { month: 'short', day: 'numeric', year: 'numeric' };
            
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('en-US', timeOptions);
            }
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('en-US', dateOptions).toUpperCase();
            }
        }

        // Navigation functions
        function goHome() {
            console.log('Already on home page');
        }

        function openSettings() {
            window.location.href = '/settings';
        }

        function openAnalytics() {
            window.location.href = '/analytics';
        }

        function emergencyStop() {
            if (confirm('EMERGENCY STOP\n\nThis will immediately stop ALL equipment.\nAre you sure?')) {
                console.log('Emergency stop activated');
                
                // Set state FIRST before any async calls
                cycleState = 'emergency';
                systemState = 'emergency';
                
                // Update UI immediately
                updateButtonStates();
                
                // Update all equipment display to OFF
                document.querySelectorAll('.equipment-item').forEach(item => {
                    item.classList.remove('on', 'idle');
                    item.classList.add('off');
                    const statusText = item.querySelector('.equipment-status-text');
                    if (statusText) statusText.textContent = 'OFF';
                });
                
                // THEN call backend
                fetch('/api/emergency-stop', { 
                    method: 'POST' 
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Emergency stop response:', data);
                    // Don't call updateDashboard here - it might overwrite our state
                    // The periodic update will refresh in 2 seconds anyway
                })
                .catch(err => {
                    console.error('Emergency stop API error:', err);
                    // On error, still keep emergency state locally
                });
            }
        }

        // Adjust setpoint
        function adjustSetpoint() {
            const newSetpoint = prompt('Enter new VPD setpoint (kPa):', currentVPD.toFixed(2));
            if (newSetpoint && !isNaN(newSetpoint)) {
                const value = parseFloat(newSetpoint);
                if (value >= VPD_MIN && value <= VPD_MAX) {
                    fetch('/api/setpoint', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({vpd_target: value})
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Setpoint updated:', data);
                        currentVPD = value;
                        updateVPDDisplay();
                    })
                    .catch(error => {
                        console.error('Error updating setpoint:', error);
                        alert('Failed to update setpoint');
                    });
                } else {
                    alert(`VPD must be between ${VPD_MIN} and ${VPD_MAX} kPa`);
                }
            }
        }

        // Toggle equipment
        function toggleEquipmentMode(element, equipmentId) {
            // Cycle through modes: AUTO -> ON -> OFF -> AUTO
            const currentMode = element.dataset.mode || 'AUTO';
            let newMode;
            
            if (currentMode === 'AUTO') {
                newMode = 'ON';
            } else if (currentMode === 'ON') {
                newMode = 'OFF';
            } else {
                newMode = 'AUTO';
            }
            
            // Send mode change to backend
            fetch(`/api/equipment/${equipmentId}/mode`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: newMode })
            })
            .then(response => response.json())
            .then(data => {
                console.log(`${equipmentId} mode changed to ${newMode}`);
                element.dataset.mode = newMode;
                updateEquipmentDisplay(element, newMode, data.actual_state);
            })
            .catch(error => {
                console.error('Error changing equipment mode:', error);
            });
        }

        function updateEquipmentDisplay(element, mode, actualState) {
            // Remove all mode classes
            element.classList.remove('auto', 'manual-on', 'manual-off');
            
            // Add mode indicator
            let modeIndicator = element.querySelector('.equipment-mode');
            if (!modeIndicator) {
                modeIndicator = document.createElement('div');
                modeIndicator.className = 'equipment-mode';
                element.appendChild(modeIndicator);
            }
            
            // Update based on mode
            if (mode === 'AUTO') {
                element.classList.add('auto');
                modeIndicator.textContent = 'AUTO';
                
                // Show actual state in AUTO mode
                element.classList.remove('on', 'off', 'idle');
                element.classList.add(actualState.toLowerCase());
                
                const statusText = element.querySelector('.equipment-status-text');
                if (statusText) {
                    statusText.textContent = actualState;
                }
                
                // Add auto state indicator
                let autoState = element.querySelector('.equipment-auto-state');
                if (!autoState) {
                    autoState = document.createElement('div');
                    autoState.className = 'equipment-auto-state';
                    element.appendChild(autoState);
                }
                autoState.textContent = `(${actualState})`;
                
            } else if (mode === 'ON') {
                element.classList.add('manual-on', 'on');
                modeIndicator.textContent = 'MANUAL';
                
                const statusText = element.querySelector('.equipment-status-text');
                if (statusText) {
                    statusText.textContent = 'ON';
                }
                
                // Remove auto state indicator
                const autoState = element.querySelector('.equipment-auto-state');
                if (autoState) autoState.remove();
                
            } else if (mode === 'OFF') {
                element.classList.add('manual-off', 'off');
                modeIndicator.textContent = 'MANUAL';
                
                const statusText = element.querySelector('.equipment-status-text');
                if (statusText) {
                    statusText.textContent = 'OFF';
                }
                
                // Remove auto state indicator
                const autoState = element.querySelector('.equipment-auto-state');
                if (autoState) autoState.remove();
            }
        }

        // MAIN UPDATE FUNCTION - Combines all updates  
        function updateDashboard() {
            // Fetch sensor data
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    console.log('Sensor data:', data);
                    
                    // Update Zone 1 (REAL DATA from dry_room_1)
                    if (data.dry_room_1 && data.dry_room_1.temperature !== null) {
                        document.querySelector('[data-sensor="zone1-temp"]').innerHTML = 
                            Math.round(data.dry_room_1.temperature) + '<span class="sensor-unit">°F</span>';
                        document.querySelector('[data-sensor="zone1-humid"]').innerHTML = 
                            Math.round(data.dry_room_1.humidity) + '<span class="sensor-unit-humid">%</span>';
                    }
                    
                    // Update Supply (REAL DATA from supply_duct)
                    if (data.supply_duct && data.supply_duct.temperature !== null) {
                        document.querySelector('[data-sensor="supply"]').innerHTML = 
                            Math.round(data.supply_duct.temperature) + '<span class="sensor-unit">°F</span>';
                        const supplyRH = document.querySelector('[data-sensor="supply-rh"]');
                        if (supplyRH) {
                            supplyRH.innerHTML = Math.round(data.supply_duct.humidity) + '<span class="sensor-unit">%</span>';
                        }
                    }
                    
                    // Calculate room averages (from dry room sensors)
                    let temps = [];
                    let humids = [];
                    
                    if (data.dry_room_1 && data.dry_room_1.temperature !== null) {
                        temps.push(data.dry_room_1.temperature);
                        humids.push(data.dry_room_1.humidity);
                    }
                    
                    if (data.dry_room_2 && data.dry_room_2.temperature !== null) {
                        temps.push(data.dry_room_2.temperature);
                        humids.push(data.dry_room_2.humidity);
                    }
                    
                    if (data.dry_room_3 && data.dry_room_3.temperature !== null) {
                        temps.push(data.dry_room_3.temperature);
                        humids.push(data.dry_room_3.humidity);
                    }
                    
                    if (data.dry_room_4 && data.dry_room_4.temperature !== null) {
                        temps.push(data.dry_room_4.temperature);
                        humids.push(data.dry_room_4.humidity);
                    }
                    
                    if (temps.length > 0) {
                        const avgTemp = temps.reduce((a,b) => a+b, 0) / temps.length;
                        const avgHumid = humids.reduce((a,b) => a+b, 0) / humids.length;
                        
                        const avgTempEl = document.getElementById('avg-temp');
                        if (avgTempEl) avgTempEl.textContent = Math.round(avgTemp) + '°F';
                        
                        const avgHumidEl = document.getElementById('avg-humid');
                        if (avgHumidEl) avgHumidEl.textContent = Math.round(avgHumid) + '%';
                    }
                })
                .catch(error => console.error('Error fetching sensors:', error));
            
            // Fetch system status
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('System status:', data);
                    
                    // Update VPD - USE SUPPLY AIR VPD FOR DISPLAY
                    if (data.supply_vpd !== undefined && data.supply_vpd !== null) {
                        currentVPD = data.supply_vpd;
                        updateVPDDisplay();
                        
                        const vpdEl = document.getElementById('vpd-current');
                        if (vpdEl) vpdEl.textContent = currentVPD.toFixed(2) + ' kPa';
                    } else if (data.vpd_current !== undefined) {
                        // Fallback to dry room VPD if supply air not available
                        currentVPD = data.vpd_current;
                        updateVPDDisplay();
                        
                        const vpdEl = document.getElementById('vpd-current');
                        if (vpdEl) vpdEl.textContent = currentVPD.toFixed(2) + ' kPa';
                    }
                    
                    // Update dew point - USE SUPPLY AIR DEW POINT
                    if (data.supply_dew_point !== undefined && data.supply_dew_point !== null) {
                        const dewEl = document.getElementById('avg-dewpoint');
                        if (dewEl) dewEl.textContent = Math.round(data.supply_dew_point) + '°F';
                    } else if (data.dew_point !== undefined) {
                        // Fallback to dry room dew point if supply air not available
                        const dewEl = document.getElementById('avg-dewpoint');
                        if (dewEl) dewEl.textContent = Math.round(data.dew_point) + '°F';
                    }
                    
                    // Update water activity
                    if (data.water_activity_estimate !== undefined) {
                        const waterEl = document.getElementById('water-activity');
                        if (waterEl) waterEl.textContent = data.water_activity_estimate.toFixed(3);
                    }
                    
                    // Update phase/mode
                    if (data.phase) {
                        const modeEl = document.getElementById('modeText');
                        if (modeEl) modeEl.textContent = data.phase.replace(/_/g, ' ').toUpperCase();
                        
                        const progressEl = document.getElementById('modeProgress');
                        if (progressEl && data.progress !== undefined) {
                            progressEl.textContent = `Progress: ${data.progress.toFixed(1)}%`;
                        }
                    }

                    if (data.current_phase) {
                        currentPhase = data.current_phase;
                        updateSystemModeDisplay();
                    }
                    
                    // Update equipment status - THIS IS THE CRITICAL PART FOR RELAY STATUS
                    if (data.equipment) {
                        console.log('Equipment status:', data.equipment);
                        
                        // Clear all equipment states first
                        document.querySelectorAll('.equipment-item').forEach(item => {
                            item.classList.remove('on', 'off', 'idle');
                        });
                        
                        // Track humidifier state (combination of solenoid and fan)
                        let humState = 'off';
                        
                        Object.entries(data.equipment).forEach(([backendName, state]) => {
                            let frontendName = backendName;
                            
                            // Map backend names to frontend data-equipment
                            if (backendName === 'hum_solenoid' || backendName === 'hum_fan') {
                                frontendName = 'hum';
                                // Combine humidifier states - if either is ON, show as ON
                                if (state === 'ON' && humState !== 'on') {
                                    humState = 'on';
                                } else if (state === 'IDLE' && humState === 'off') {
                                    humState = 'idle';
                                }
                            } else if (backendName === 'supply_fan') {
                                frontendName = 'supply_fan';
                            } else if (backendName === 'return_fan') {
                                frontendName = 'return_fan';
                            } else {
                                frontendName = backendName; // mini_split, dehum, erv
                            }
                            
                            // Skip individual hum components, handle combined later
                            if (backendName === 'hum_solenoid' || backendName === 'hum_fan') {
                                return;
                            }
                            
                            const element = document.querySelector(`[data-equipment="${frontendName}"]`);
                            if (element) {
                                // Remove all state classes first
                                element.classList.remove('off', 'on', 'idle');
                                // Add the new state class
                                element.classList.add(state.toLowerCase());
                                // Update the status text
                                const statusText = element.querySelector('.equipment-status-text');
                                if (statusText) {
                                    statusText.textContent = state.toUpperCase();
                                }
                            }
                        });
                        
                        // Handle combined humidifier state
                        const humElement = document.querySelector('[data-equipment="hum"]');
                        if (humElement) {
                            humElement.classList.remove('off', 'on', 'idle');
                            humElement.classList.add(humState);
                            const statusText = humElement.querySelector('.equipment-status-text');
                            if (statusText) {
                                statusText.textContent = humState.toUpperCase();
                            }
                        }
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        // Helper function to update equipment element display
        function updateEquipmentElement(element, state) {
            if (!element) return;
            
            // Remove all state classes
            element.classList.remove('off', 'on', 'idle');
            
            // Add the appropriate state class
            const stateClass = state.toLowerCase();
            element.classList.add(stateClass);
            
            // Update the status text
            const statusText = element.querySelector('.equipment-status-text');
            if (statusText) {
                // Special handling for fans that show percentage when on
                const elementName = element.querySelector('.equipment-name');
                if (elementName && elementName.textContent.toLowerCase().includes('fan') && state === 'ON') {
                    statusText.textContent = '60%';
                } else {
                    statusText.textContent = state.toUpperCase();
                }
            }
            
            // Log for debugging
            console.log(`Updated ${element.className} to ${state}`);
        }

        // Function to toggle equipment when clicked
        function toggleEquipment(element, equipmentId) {
            // Clean up equipment ID (remove dashes)
            const cleanId = equipmentId.replace('-', '_');
            
            fetch(`/api/equipment/${cleanId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Toggled ${equipmentId}:`, data);
                if (data.success) {
                    // Update will happen on next dashboard update
                    // But we can update immediately for better UX
                    updateEquipmentElement(element, data.new_state);
                }
            })
            .catch(error => {
                console.error('Error toggling equipment:', error);
                alert('Failed to toggle equipment. Check connection.');
            });
        }

        // Initialize dashboard updates
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Cannabis Dryer Control System - Initializing dashboard...');
            
            // Initial update
            updateDashboard();
            
            // Set up periodic updates every 5 seconds
            setInterval(updateDashboard, 5000);
            
            console.log('Dashboard initialized - Updates every 5 seconds');
        });

        // Touch/swipe handling for VPD adjustment
        let touchStartY = 0;
        let touchStartVPD = currentVPD;

        const vpdCard = document.querySelector('.vpd-main-card');
        if (vpdCard) {
            vpdCard.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartVPD = currentVPD;
            }, { passive: true });

            vpdCard.addEventListener('touchmove', (e) => {
                const deltaY = touchStartY - e.touches[0].clientY;
                const deltaVPD = (deltaY / 100) * 0.2;
                currentVPD = Math.max(VPD_MIN, Math.min(VPD_MAX, touchStartVPD + deltaVPD));
                updateVPDDisplay();
            }, { passive: true });
        }

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Single consolidated initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all displays
            updateClock();
            updateVPDDisplay();
            updateButtonStates();
            updateDashboard();
            updateSystemModeDisplay();
            updateProgressBars();
            
            // Get initial data from controller
            updateFromController();
            
            // Set up all intervals
            setInterval(updateClock, 60000);          // Update time every minute
            setInterval(updateDashboard, 2000);       // Update sensors every 2 seconds
            setInterval(updateFromController, 2000);  // Update controller every 2 seconds
            
            // Hook up the start button 
            const startBtn = document.getElementById('start-btn');
            if (startBtn) {

                startBtn.addEventListener('click', () => {
                    if (systemState === 'idle' || systemState === 'complete') {
                        startProcess();
                    } else if (cycleState === 'emergency') {
                        // Resume from emergency stop
                        if (confirm('Resume normal operation from emergency stop?')) {
                            fetch('/api/process/start', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ resume_from_emergency: true })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Resumed from emergency:', data);
                                cycleState = 'running';
                                systemState = 'running';
                                updateButtonStates();
                                updateSystemModeDisplay();
                                updateFromController();
                            })
                            .catch(err => {
                                console.error('Failed to resume from emergency:', err);
                                alert('Failed to resume. Check system status.');
                            });
                        }
                    } else if (cycleState === 'holding') {
                        // Resume from hold mode
                        if (confirm('Resume normal drying process from hold mode?')) {
                            fetch('/api/process/start', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ resume_from_hold: true })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Resumed from hold:', data);
                                cycleState = 'running';
                                systemState = 'running';
                                updateButtonStates();
                                updateSystemModeDisplay();
                                updateFromController();
                            })
                            .catch(err => {
                                console.error('Failed to resume from hold:', err);
                                alert('Failed to resume. Check system status.');
                            });
                        }
                    } else {
                        alert('Process is already running!');
                    }
                });
            }

           

            // Hook up the hold button  
            const holdBtn = document.getElementById('hold-btn');
            if (holdBtn) {
                holdBtn.addEventListener('click', () => {
                    // Allow Hold from running OR emergency state
                    if (cycleState === 'running' || cycleState === 'emergency') {
                        const confirmMsg = cycleState === 'emergency' 
                            ? 'Recover from emergency stop into storage/hold mode?' 
                            : 'Switch to storage/hold mode?';
                        
                        if (confirm(confirmMsg)) {
                            fetch('/api/process/hold', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'}
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Switched to hold/storage:', data);
                                cycleState = 'holding';
                                updateButtonStates();
                                updateDashboard();
                            })
                            .catch(err => console.error('Hold process error:', err));
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>